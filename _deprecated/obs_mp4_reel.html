<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OBS MP4 Reel</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      width: 100%;
      background: #000;
      overflow: hidden;
    }
    video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }
    #status {
      position: fixed;
      top: 10px;
      left: 10px;
      color: #0f0;
      font: 14px monospace;
      z-index: 9999;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 6px;
      max-width: 500px;
      white-space: pre-wrap;
    }
    #hud {
      position: fixed;
      bottom: 20px;
      left: 20px;
      color: #fff;
      font: 16px 'Segoe UI', sans-serif;
      z-index: 9999;
      background: rgba(0,0,0,0.7);
      padding: 12px 16px;
      border-radius: 8px;
      max-width: 50%;
      opacity: 0;
      transition: opacity 0.3s;
    }
    #hud.visible { opacity: 1; }
    #hud .title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    #hud .meta {
      font-size: 13px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div id="status">Loading...</div>
  <div id="hud">
    <div class="title" id="clip-title"></div>
    <div class="meta" id="clip-meta"></div>
  </div>
  <video id="player" autoplay playsinline></video>

<script>
(async () => {
  const qs = new URLSearchParams(location.search);
  const login = (qs.get("login") || "floppyjimmie").toLowerCase();
  const muted = qs.get("muted") === "1";

  const status = document.getElementById("status");
  const player = document.getElementById("player");
  const hud = document.getElementById("hud");
  const clipTitle = document.getElementById("clip-title");
  const clipMeta = document.getElementById("clip-meta");

  const API_BASE = "https://clipsystem-production.up.railway.app";

  // Set muted state
  player.muted = muted;

  let clips = [];
  let currentIndex = 0;
  let failedClips = new Set(); // Track clips that failed to load

  function log(msg) {
    console.log("[MP4-REEL]", msg);
    status.textContent = msg;
  }

  function showHud(clip) {
    clipTitle.textContent = clip.title || clip.id;
    clipMeta.textContent = `${clip.view_count?.toLocaleString() || "?"} views â€¢ ${clip.duration}s`;
    hud.classList.add("visible");
  }

  function hideHud() {
    hud.classList.remove("visible");
  }

  // Get signed MP4 URL from our API (uses Twitch GQL)
  async function getMp4Url(clipId) {
    try {
      const res = await fetch(`${API_BASE}/clip_mp4_url.php?slug=${encodeURIComponent(clipId)}`);
      if (!res.ok) return null;
      const data = await res.json();
      return data.mp4_url || null;
    } catch (err) {
      console.error("[MP4-REEL] Failed to get MP4 URL:", err);
      return null;
    }
  }

  async function playClip(clip) {
    log(`Loading: ${clip.title || clip.id}`);

    // Get signed MP4 URL from Twitch GQL
    const mp4Url = await getMp4Url(clip.id);

    if (!mp4Url) {
      log(`No MP4 URL for ${clip.id}, skipping...`);
      failedClips.add(clip.id);
      nextClip();
      return;
    }

    console.log("[MP4-REEL] Playing:", mp4Url);

    // Hide HUD during transition
    hideHud();

    // Set video source
    player.src = mp4Url;
    player.load();

    // Play when ready
    player.oncanplay = () => {
      player.play().then(() => {
        log(`Playing: ${clip.title || clip.id} (${clip.duration}s)`);
        showHud(clip);

        // Hide status after a moment
        setTimeout(() => {
          status.style.display = "none";
        }, 2000);
      }).catch(err => {
        log(`Play error: ${err.message}`);
        failedClips.add(clip.id);
        nextClip();
      });
    };

    player.onerror = () => {
      log(`Error loading MP4, skipping...`);
      failedClips.add(clip.id);
      setTimeout(nextClip, 500);
    };

    // Report now playing
    fetch(`${API_BASE}/now_playing.php`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        login: login,
        clip_id: clip.id,
        title: clip.title,
        duration: clip.duration,
        view_count: clip.view_count
      })
    }).catch(() => {});
  }

  function nextClip() {
    // Find next clip that hasn't failed
    let attempts = 0;
    do {
      currentIndex = (currentIndex + 1) % clips.length;
      attempts++;
    } while (failedClips.has(clips[currentIndex].id) && attempts < clips.length);

    if (attempts >= clips.length) {
      log("All clips failed!");
      return;
    }

    playClip(clips[currentIndex]);
  }

  // When video ends, play next
  player.onended = () => {
    console.log("[MP4-REEL] Video ended, playing next...");
    nextClip();
  };

  // Fetch clips - get ALL clips (GQL can get MP4 for any clip)
  log("Fetching clips...");
  try {
    const res = await fetch(`${API_BASE}/twitch_reel_api.php?login=${encodeURIComponent(login)}&days=180&pool=200`);
    const data = await res.json();
    clips = data.clips || [];

    log(`Loaded ${clips.length} clips`);

    if (clips.length === 0) {
      log("No clips found!");
      return;
    }

    // Shuffle
    clips.sort(() => Math.random() - 0.5);

    // Start playing
    currentIndex = 0;
    playClip(clips[0]);

  } catch (err) {
    log("Error: " + err.message);
    console.error(err);
  }
})();
</script>
</body>
</html>
